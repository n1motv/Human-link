{% extends "admin_base.html" %}

{% block title %}Affecter Employés aux Managers{% endblock %}

{% block content2 %}
            <div class="d-flex justify-content-center">
                <div id="search-results" class="container m-3"></div>
            </div>
            <div class="toggle-visibility">
            <h1 class="text-center text-white mb-4">Affecter des Employés aux Managers</h1>
            <!-- Formulaire pour designer un directeur -->
            <div class="d-flex justify-content-center mb-4">
                <form action="{{ url_for('designer_directeur') }}" method="POST" class="w-50">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="directeur" class="form-label text-white">Directeur :</label>
                            <select name="manager" id="directeur" class="form-select" required>
                                <option value="">-- Sélectionnez un Manager --</option>
                                {% for manager in managers %}
                                    <option value="{{ manager[0] }}">{{ manager[1] }} ({{ manager[2] }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-primary">Mettre à jour</button>
                    </div>
                </form>
            </div>

            <!-- Section pour assigner des supervisions -->
            <h3 class="text-white mb-4">Assignations de Supervision</h3>
            <form action="{{ url_for('assigner_manager') }}" method="POST" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="manager" class="form-label text-white">Manager :</label>
                        <select name="manager" id="manager" class="form-select" required>
                            <option value="">-- Sélectionnez un Manager --</option>
                            {% for manager in managers %}
                                <option value="{{ manager[0] }}">{{ manager[1] }} ({{ manager[2] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="supervise" class="form-label text-white">Supervisé :</label>
                        <!-- Liste des superviseurs -->
                    <select name="supervise" id="supervise" class="form-select" required>
                        <option value="">-- Sélectionnez un Employé --</option>
                        {% for employe in employes %}
                            <option value="{{ employe[0] }}">{{ employe[1] }} ({{ employe[2] }})</option>
                        {% endfor %}
                        {% for manager in managers %}
                            {% if manager[0] != directeur_id and manager[0] != request.form.get('manager') %}
                                <option value="{{ manager[0] }}">{{ manager[1] }} (Manager)</option>
                            {% endif %}
                        {% endfor %}
                    </select>

                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" class="btn btn-primary">Assigner</button>
                </div>
            </form>

            <h3 class="text-white mb-4">Liste des Assignations Actuelles</h3>
            <div class="d-flex flex-wrap justify-content-center">
                {% for manager in managers %}
                    {% set supervised_items = assignations | selectattr("manager_id", "equalto", manager[0]) | list %}
                    {% if supervised_items or manager.is_director %}
                    <div class="m-3" style="width: 300px;">
                        <div class="card">
                            <div class="card-header bg-dark text-white text-center">
                                {{ manager[1] }} {% if manager.is_director %}(Directeur){% endif %}
                            </div>
                            <div class="card-body">
                                {% if supervised_items %}
                                <h5 class="card-title text-center">Supervise :</h5>
                                <ul class="list-group list-group-flush">
                                    {% for item in supervised_items %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ item.supervise_nom }}
                                        <form action="{{ url_for('supprimer_assignation', manager_id=manager[0], supervise_id=item.supervise_id) }}" method="POST">
                                            <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                                        </form>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-muted">Aucune supervision.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            </div>    
            <h1 class="text-center text-white mb-4">Organigramme des Employés et Managers</h1>
            <div class="org-chart-container">
                <div id="orgChart" class="org-chart"></div>
            </div>
            {% endblock %}
{% block content3 %}
    <script>
        $(document).ready(function () {
            function refreshOrgChart() {
                $.get('/api/récupérer_orgchart', function (data) {
                    $('#orgChart').empty().orgchart({
                        data: data,
                        nodeContent: 'title',
                        pan: true,
                        zoom: true,
                        verticalDepth: 1,
                        toggleSiblingsResp: true,
                    });
                    $('.orgchart').css({
                    'background-image': 'none', // Enlever les carreaux
                    'background-color': 'none', // Définit un fond blanc ou autre couleur unie
                    });
                });

            }
            

            refreshOrgChart();

            $('form[action="{{ url_for('assigner_manager') }}"]').on('submit', function(event) {
                event.preventDefault();
                $.post($(this).attr('action'), $(this).serialize(), function() {
                    location.reload();
                });
            });
        });
        document.getElementById('manager').addEventListener('change', function () {
            const selectedManager = this.value;
            const superviseSelect = document.getElementById('supervise');

            Array.from(superviseSelect.options).forEach(option => {
                if (option.value === selectedManager || option.value === '{{ directeur_id }}') {
                    option.style.display = 'none'; // Masquer l'option
                } else {
                    option.style.display = 'block'; // Afficher les autres options
                }
            });
        });
        
        
    </script>
    <script>
        function searchUser() {
            const userId = document.getElementById('searchInput').value.trim();
            const userType = document.getElementById('searchType').value;

            if (!userId || !userType) {
                alert('Veuillez sélectionner un type et entrer un ID utilisateur.');
                return;
            }

            fetch(`/api/récupérer_user_infos?user_id=${userId}&user_type=${userType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        displayResults(data, userType);
                    }
                })
                .catch(error => console.error('Erreur:', error));
        }

        function displayResults(data, userType) {
            const resultsContainer = document.getElementById('search-results');
            const otherSections = document.querySelectorAll('.toggle-visibility');
            const orgChart = document.getElementById('orgChart');

            // Cacher les autres sections
            otherSections.forEach(section => section.classList.add('hidden'));

            // Afficher les résultats de recherche
            resultsContainer.style.display = 'flex';
            resultsContainer.innerHTML = '';

            let html = '';
            if (userType === 'directeur' && data.directeur) {
                html += generateCard('Directeur', data.directeur);
            } else if (userType === 'manager' && data.manager) {
                html += generateCard('Manager', data.manager);
                if (data.manager.directeur) {
                    html += generateCard('Directeur', data.manager.directeur);
                }
            } else if (userType === 'employe' && data.employe) {
                if (data.employe.manager) {
                    html += generateCard('Manager', data.employe.manager);
                }
                html += generateCard('Employé', data.employe);
            }

            resultsContainer.innerHTML = html;

            // Afficher l'organigramme
            orgChart.classList.remove('hidden');
        }



        function generateCard(role, user) {
            return `
                <div class="card">
                    <div class="card-header bg-dark text-white">${role}</div>
                    <div class="card-body">
                        <h5 class="card-title">${user.nom}</h5>
                        <p class="card-text">Email: ${user.email}</p>
                    </div>
                </div>
            `;
        }
    </script>
{% endblock %}
