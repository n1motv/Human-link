<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affecter Employés aux Managers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/orgchart@2.1.0/dist/css/jquery.orgchart.min.css">
    <link rel="stylesheet" href="../static/styles.css">
    <style>


    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a href="{{ url_for('admin_dashboard') }}">
                <img id="main-logo" src="../static/logo/logo-white.png" alt="">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse text-center" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link mx-2" href="{{ url_for('afficher_employés') }}">
                            <i class="bi bi-person"></i> Voir les employés
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link mx-2" href="{{ url_for('ajouter_employe_page') }}">
                            <i class="bi bi-person-plus-fill"></i> Ajouter un employé
                        </a>
                    </li>

                    
                    <li class="nav-item">
                        <form class="d-flex mx-2">
                            <select class="form-select me-2" style="width: fit-content;" id="searchType">
                                <option value="directeur">Directeur</option>
                                <option value="manager">Manager</option>
                                <option value="employe">Employé</option>
                            </select>
                            <input class="form-control me-2" type="search" id="searchInput" placeholder="Rechercher Immatricule" aria-label="Rechercher">
                            <button class="btn btn-custom-search" type="button" onclick="searchUser()">
                                <i class="bi bi-search"></i>
                            </button>
                        </form>
                    </li>
                    <li class="nav-item dropdown ">
                        <a class="nav-link dropdown-toggle " href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Plus
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li class="nav-item">
                                <a class="nav-link mx-2" href="{{ url_for('calendrier_congés') }}">
                                    <i class="bi bi-calendar-check"></i> Calendrier Congés
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link mx-2" href="{{ url_for('afficher_demandes_congé') }}">
                                    <i class="bi bi-envelope-fill"></i> Demandes de congés
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link mx-2" href="{{ url_for('afficher_demandes_arrêts') }}">
                                    <i class="bi bi-file-earmark-text"></i> Demandes d'arrêts
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link mx-2" href="{{ url_for('coffre_fort', id_employe='admin') }}">
                                    <i class="bi bi-calendar-check"></i> Déposer documents
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link mx-2" href="{{ url_for('logout') }}">
                                    <i class="bi bi-box-arrow-right"></i> Se déconnecter
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div id="main-body">
    <main class="py-5">
        <div class="container">
            <div class="d-flex justify-content-center">
                <div id="search-results" class="container m-3"></div>
            </div>
            <div class="toggle-visibility">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="alert alert-danger" role="alert">
                        {% for category, message in messages %}
                            {{ message }}
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
            <h1 class="text-center text-white mb-4">Affecter des Employés aux Managers</h1>


            <!-- Formulaire pour designer un directeur -->
            <div class="d-flex justify-content-center mb-4">
                <form action="{{ url_for('designer_directeur') }}" method="POST" class="w-50">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="directeur" class="form-label text-white">Directeur :</label>
                            <select name="manager" id="directeur" class="form-select" required>
                                <option value="">-- Sélectionnez un Manager --</option>
                                {% for manager in managers %}
                                    <option value="{{ manager[0] }}">{{ manager[1] }} ({{ manager[2] }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-4">
                        <button type="submit" class="btn btn-primary">Mettre à jour</button>
                    </div>
                </form>
            </div>

            <!-- Section pour assigner des supervisions -->
            <h3 class="text-white mb-4">Assignations de Supervision</h3>
            <form action="{{ url_for('assigner_manager') }}" method="POST" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="manager" class="form-label text-white">Manager :</label>
                        <select name="manager" id="manager" class="form-select" required>
                            <option value="">-- Sélectionnez un Manager --</option>
                            {% for manager in managers %}
                                <option value="{{ manager[0] }}">{{ manager[1] }} ({{ manager[2] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="supervise" class="form-label text-white">Supervisé :</label>
                        <!-- Liste des superviseurs -->
                    <select name="supervise" id="supervise" class="form-select" required>
                        <option value="">-- Sélectionnez un Employé ou Manager --</option>
                        {% for employe in employes %}
                            <option value="{{ employe[0] }}">{{ employe[1] }} ({{ employe[2] }})</option>
                        {% endfor %}
                        {% for manager in managers %}
                            {% if manager[0] != directeur_id and manager[0] != request.form.get('manager') %}
                                <option value="{{ manager[0] }}">{{ manager[1] }} (Manager)</option>
                            {% endif %}
                        {% endfor %}
                    </select>

                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" class="btn btn-primary">Assigner</button>
                </div>
            </form>

            <h3 class="text-white mb-4">Liste des Assignations Actuelles</h3>
            <div class="d-flex flex-wrap justify-content-center">
                {% for manager in managers %}
                    {% set supervised_items = assignations | selectattr("manager_id", "equalto", manager[0]) | list %}
                    {% if supervised_items or manager.is_director %}
                    <div class="m-3" style="width: 300px;">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                {{ manager[1] }} {% if manager.is_director %}(Directeur){% endif %}
                            </div>
                            <div class="card-body">
                                {% if supervised_items %}
                                <h5 class="card-title">Supervise :</h5>
                                <ul class="list-group list-group-flush">
                                    {% for item in supervised_items %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ item.supervise_nom }}
                                        <form action="{{ url_for('supprimer_assignation', manager_id=manager[0], supervise_id=item.supervise_id) }}" method="POST">
                                            <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                                        </form>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-muted">Aucune supervision.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            </div>    
            <h1 class="text-center text-white mb-4">Organigramme des Employés et Managers</h1>
            <div class="org-chart-container">
                <div id="orgChart" class="org-chart"></div>
            </div>
        </div>
    </main>

    <footer class="mt-auto">
        <div class="container text-center">
            <p>&copy; 2024 Gestionnaire RH. Tous droits réservés.</p>
        </div>
    </footer>
    </div>
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/orgchart@2.1.0/dist/js/jquery.orgchart.min.js"></script>
    <script>
        $(document).ready(function () {
            function refreshOrgChart() {
                $.get('/api/récupérer_orgchart', function (data) {
                    $('#orgChart').empty().orgchart({
                        data: data,
                        nodeContent: 'title',
                        pan: true,
                        zoom: true,
                        verticalDepth: 1,
                        toggleSiblingsResp: true,
                    });
                    $('.orgchart').css({
                    'background-image': 'none', // Enlever les carreaux
                    'background-color': 'none', // Définit un fond blanc ou autre couleur unie
                    });
                });

            }
            

            refreshOrgChart();

            $('form[action="{{ url_for('assigner_manager') }}"]').on('submit', function(event) {
                event.preventDefault();
                $.post($(this).attr('action'), $(this).serialize(), function() {
                    location.reload();
                });
            });
        });
        document.getElementById('manager').addEventListener('change', function () {
            const selectedManager = this.value;
            const superviseSelect = document.getElementById('supervise');

            Array.from(superviseSelect.options).forEach(option => {
                if (option.value === selectedManager || option.value === '{{ directeur_id }}') {
                    option.style.display = 'none'; // Masquer l'option
                } else {
                    option.style.display = 'block'; // Afficher les autres options
                }
            });
        });
        
        
    </script>
    <script>
        function searchUser() {
            const userId = document.getElementById('searchInput').value.trim();
            const userType = document.getElementById('searchType').value;

            if (!userId || !userType) {
                alert('Veuillez sélectionner un type et entrer un ID utilisateur.');
                return;
            }

            fetch(`/api/récupérer_user_infos?user_id=${userId}&user_type=${userType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        displayResults(data, userType);
                    }
                })
                .catch(error => console.error('Erreur:', error));
        }

        function displayResults(data, userType) {
            const resultsContainer = document.getElementById('search-results');
            const otherSections = document.querySelectorAll('.toggle-visibility');
            const orgChart = document.getElementById('orgChart');

            // Cacher les autres sections
            otherSections.forEach(section => section.classList.add('hidden'));

            // Afficher les résultats de recherche
            resultsContainer.style.display = 'flex';
            resultsContainer.innerHTML = '';

            let html = '';
            if (userType === 'directeur' && data.directeur) {
                html += generateCard('Directeur', data.directeur);
            } else if (userType === 'manager' && data.manager) {
                html += generateCard('Manager', data.manager);
                if (data.manager.directeur) {
                    html += generateCard('Directeur', data.manager.directeur);
                }
            } else if (userType === 'employe' && data.employe) {
                if (data.employe.manager) {
                    html += generateCard('Manager', data.employe.manager);
                }
                html += generateCard('Employé', data.employe);
            }

            resultsContainer.innerHTML = html;

            // Afficher l'organigramme
            orgChart.classList.remove('hidden');
        }



        function generateCard(role, user) {
            return `
                <div class="card">
                    <div class="card-header bg-dark text-white">${role}</div>
                    <div class="card-body">
                        <h5 class="card-title">${user.nom}</h5>
                        <p class="card-text">Email: ${user.email}</p>
                    </div>
                </div>
            `;
        }
    </script>
    
</body>
</html>
